@page "/anilistplanning"
@inject HttpClient Http

<PageTitle>Planning List Sorter</PageTitle>

<MudText Typo="Typo.h4">Planning List Sorter</MudText>

<div class="row p-3">
	<MudTextField Class="col-11" Placeholder="Enter a username to get entries from..." 
		@bind-Value="@Username" 
	/>
	<MudButton Class="col-1" Color="Color.Primary" OnClick="@LoadEntries">
		Load Entries
	</MudButton>
</div>

<MudTable Dense="true" Hover="true" Bordered="true" Striped="true"
	FixedHeader="true" FixedFooter="true" Height="700px"
	Items="@Entries" Context="entry" Filter="@(x => x.IsEntryVisible)">
	<ToolBarContent>
		<MudText Typo="Typo.h6">Planning To Watch</MudText>
		<MudSpacer />
		<MudButton Color="Color.Primary" OnClick="@ToggleSearchVisibility"
			Disabled="@(Entries.Count == 0)">
			Search
		</MudButton>
	</ToolBarContent>
	<HeaderContent>
		<MudTh>
			<MudTableSortLabel SortBy="@((AnilistMedia m) => m.Id)">
				Id
			</MudTableSortLabel>
		</MudTh>
		<MudTh>
			<MudTableSortLabel SortBy="@((AnilistMedia m) => m.Title.UserPreferred)">
				Name
			</MudTableSortLabel>
		</MudTh>
		<MudTh>
			<MudTableSortLabel SortBy="@((AnilistMedia m) => m.Format.ToString())">
				Format
			</MudTableSortLabel>
		</MudTh>
		<MudTh>
			<MudTableSortLabel SortBy="@((AnilistMedia m) => m.GetHighestEpisode())" Class="text-nowrap">
				Episode Count
			</MudTableSortLabel>
		</MudTh>
		<MudTh>
			<MudTableSortLabel SortBy="@((AnilistMedia m) => m.GetTotalDuration())">
				Duration
			</MudTableSortLabel>
		</MudTh>
		<MudTh>
			<MudTableSortLabel SortBy="@((AnilistMedia m) => m.AverageScore)" Class="text-nowrap">
				Average Score
			</MudTableSortLabel>
		</MudTh>
		<MudTh>
			<MudTableSortLabel SortBy="@((AnilistMedia m) => m.Popularity)">
				Popularity
			</MudTableSortLabel>
		</MudTh>
		<MudTh>
			<MudTableSortLabel SortBy="@((AnilistMedia m) => m.StartDate!.Year)" Class="text-nowrap">
				Start Year
			</MudTableSortLabel>
		</MudTh>
		<MudTh>Genres</MudTh>
		<MudTh>Tags</MudTh>
	</HeaderContent>
	<RowTemplate>
		<MudTd>
			<MudNavLink Href="@entry.GetUrl()" Target="_blank">
				@entry.Id
			</MudNavLink>
		</MudTd>
		<MudTd>@entry.Title.UserPreferred</MudTd>
		<MudTd>@entry.DisplayFormat()</MudTd>
		<MudTd Class="text-nowrap">@entry.DisplayEpisodeCount()</MudTd>
		<MudTd Class="text-nowrap">@entry.DisplayDuration()</MudTd>
		<MudTd>@entry.DisplayScore()</MudTd>
		<MudTd>@entry.Popularity</MudTd>
		<MudTd>@entry.DisplayYear()</MudTd>
		<MudTd>
			<MudExpansionPanel Class="bg-transparent"
				Text="@entry.DisplayGenres(expanded: false)"
				HideIcon="@(entry.Genres.Count <= 1)" Disabled="@(entry.Genres.Count <= 1)">
				<MudText Class="text-pre">
					@entry.DisplayGenres(expanded: true)
				</MudText>
			</MudExpansionPanel>
		</MudTd>
		<MudTd>
			<MudExpansionPanel Class="bg-transparent" 
				Text="@entry.DisplayTags(expanded: false)"
				HideIcon="@(entry.Tags.Count <= 1)" Disabled="@(entry.Tags.Count <= 1)">
				<MudText Class="text-pre">
					@entry.DisplayTags(expanded: true)
				</MudText>
			</MudExpansionPanel>
		</MudTd>
	</RowTemplate>
	<PagerContent>
		<MudTablePager />
	</PagerContent>
</MudTable>

<MudDialog @bind-IsVisible="IsSearchVisible" Options="SearchDialogOptions">
	<TitleContent>
		<MudText Typo="Typo.h6">Search</MudText>
	</TitleContent>
	<DialogContent>
		<div class="container overflow-hidden">
			<MudSelect Label="Genre Select" Variant="Variant.Outlined"
				MultiSelection="true" Clearable="true"
				T="string" SelectedValues="@Search.Genres"
				SelectedValuesChanged="@Search.SetGenres">
				<Virtualize Items="@Search.AllowedGenres" Context="genre">
					<MudSelectItem Value="@genre">@genre</MudSelectItem>
				</Virtualize>
			</MudSelect>
			<MudSelect Label="Tag Select" Variant="Variant.Outlined"
				MultiSelection="true" Clearable="true"
				T="string" SelectedValues="@Search.Tags"
				SelectedValuesChanged="@Search.SetTags">
				<Virtualize Items="@Search.AllowedTags" Context="tag">
					<MudSelectItem Value="@tag">@tag</MudSelectItem>
				</Virtualize>
			</MudSelect>
			<MudSelect Label="Format Select" Variant="Variant.Outlined"
				MultiSelection="true" Clearable="true"
				T="string" SelectedValues="@Search.Formats"
				SelectedValuesChanged="@Search.SetFormats">
				<Virtualize Items="@Search.AllowedFormats" Context="format">
					<MudSelectItem Value="@format">@format</MudSelectItem>
				</Virtualize>
			</MudSelect>
			<div class="row">
				<div class="col-sm">
					<MudNumericField Label="Minimum Duration" Variant="Variant.Outlined"
						Min="0" Max="@Search.MaximumDuration"
						T="int?" Value="@Search.MinimumDuration"
						ValueChanged="@Search.SetMinimumDuration" />
				</div>
				<div class="col-sm">
					<MudNumericField Label="Maximum Duration" Variant="Variant.Outlined"
						Min="@(Search.MinimumDuration ?? 0)" Max="int.MaxValue"
						T="int?" Value="@Search.MaximumDuration"
						ValueChanged="@Search.SetMaximumDuration" />
				</div>
			</div>
			<div class="row">
				<div class="col-sm">
					<MudNumericField Label="Minimum Year" Variant="Variant.Outlined"
						Min="0" Max="@Search.MaximumYear"
						T="int?" Value="@Search.MinimumYear"
						ValueChanged="@Search.SetMinimumYear" />
				</div>
				<div class="col-sm">
					<MudNumericField Label="Maximum Year" Variant="Variant.Outlined"
						Min="@(Search.MinimumYear ?? 0)" Max="int.MaxValue"
						T="int?" Value="@Search.MaximumYear"
						ValueChanged="@Search.SetMaximumYear" />
				</div>
			</div>
		</div>
	</DialogContent>
	<DialogActions>
		<MudButton Class="float-end" Color="Color.Secondary" Size="Size.Small"
			OnClick="@Search.Clear">
			Clear
		</MudButton>
	</DialogActions>
</MudDialog>