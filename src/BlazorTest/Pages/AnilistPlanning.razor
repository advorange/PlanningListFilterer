@page "/anilistplanning"
@inject HttpClient Http
@inject ILocalStorageService LocalStorage

<PageTitle>Planning List Sorter</PageTitle>

<MudText Typo="Typo.h4">Planning List Sorter</MudText>

<MudTable Dense="true" Hover="true" Bordered="true" Striped="true"
		  AllowUnsorted="false" FixedHeader="true" FixedFooter="true"
		  Height="80vh" @ref="Table" Items="@Entries" Context="entry"
		  Filter="@(x => x.IsEntryVisible)">
	<ToolBarContent>
		<MudText Typo="Typo.h6">Planning List</MudText>
		<MudSpacer />
		<MudTextField Placeholder="Enter a username to get entries from..."
					  @bind-Value="@Username" />
		<MudButton Color="Color.Primary" OnClick="@LoadEntries">
			Load Entries
		</MudButton>
		<MudButton Color="Color.Primary" OnClick="@RandomizeTable"
				   Disabled="@(Entries.Count == 0)">
			Random
		</MudButton>
		<MudButton Color="Color.Primary" OnClick="@ToggleSearchVisibility"
				   Disabled ="@(Entries.Count == 0)">
			Filter
		</MudButton>
	</ToolBarContent>

	<HeaderContent>
		<MudTh>
			<MudTableSortLabel SortBy="@((AnilistModel m) => m.Id)">Id</MudTableSortLabel>
		</MudTh>
		<MudTh>
			<MudTableSortLabel SortBy="@((AnilistModel m) => m.Title)">Name</MudTableSortLabel>
		</MudTh>
		<MudTh>
			<MudTableSortLabel SortBy="@((AnilistModel m) => m.Start)">Release</MudTableSortLabel>
		</MudTh>
		<MudTh>
			<MudTableSortLabel SortBy="@((AnilistModel m) => m.GetHighestEpisode())">Episodes</MudTableSortLabel>
		</MudTh>
		<MudTh>
			<MudTableSortLabel SortBy="@((AnilistModel m) => m.GetTotalDuration())">Duration</MudTableSortLabel>
		</MudTh>
		<MudTh>
			<MudTableSortLabel SortBy="@((AnilistModel m) => m.AverageScore)">Score</MudTableSortLabel>
		</MudTh>
		<MudTh>
			<MudTableSortLabel SortBy="@((AnilistModel m) => m.Popularity)">Popularity</MudTableSortLabel>
		</MudTh>
		<MudTh>
			<MudTableSortLabel SortBy="@((AnilistModel m) => m.Format.ToString())">Format</MudTableSortLabel>
		</MudTh>
		<MudTh>Genres</MudTh>
		<MudTh>Tags</MudTh>
	</HeaderContent>

	<RowTemplate>
		<MudTd>
			<MudNavLink Class="transparent-hover-bg" Href="@entry.GetUrl()" Target="_blank">
				<MudImage Src="@entry.CoverImageUrl" ObjectFit="ObjectFit.Fill" />
			</MudNavLink>
		</MudTd>
		<MudTd Class="text-wrap">@entry.Title</MudTd>
		<MudTd Class="text-nowrap">@entry.DisplayStart()</MudTd>
		<MudTd Class="text-nowrap">@entry.DisplayEpisodeCount()</MudTd>
		<MudTd Class="text-nowrap">@entry.DisplayDuration()</MudTd>
		<MudTd Class="text-nowrap">@entry.DisplayScore()</MudTd>
		<MudTd Class="text-nowrap">@entry.Popularity</MudTd>
		<MudTd Class="text-nowrap">@entry.DisplayFormat()</MudTd>
		<MudTd Class="text-pre">@entry.DisplayGenres()</MudTd>
		<MudTd>
			<MudExpansionPanel Class="bg-transparent" Text="@entry.DisplayTags(0, 1)"
							   Disabled="@(entry.Tags.Count <= 1)"
							   HideIcon="@(entry.Tags.Count <= 1)">
				<MudText Class="text-pre">@entry.DisplayTags(1, int.MaxValue)</MudText>
			</MudExpansionPanel>
		</MudTd>
	</RowTemplate>

	<PagerContent>
		<MudTablePager />
	</PagerContent>
</MudTable>

<MudDialog Options="@SearchDialogOptions" @bind-IsVisible="@IsSearchVisible">
	<TitleContent>
		<MudText Typo="Typo.h6">Filter</MudText>
	</TitleContent>

	<DialogContent>
		<div class="overflow-hidden">
			<SearchSelection Selection="@Search.Genres" Label="Genre" />
			<SearchSelection Selection="@Search.Tags" Label="Tag" />
			<SearchSelection Selection="@Search.Formats" Label="Format" />
			<SearchMinMax Source="@Search.Score" Label="Score" />
			<SearchMinMax Source="@Search.Duration" Label="Duration" />
			<SearchMinMax Source="@Search.Year" Label="Year" />
			<SearchMinMax Source="@Search.Popularity" Label="Popularity" />
		</div>
	</DialogContent>

	<DialogActions>
		<MudButton Class="float-end" Color="Color.Secondary" Size="Size.Small"
				   OnClick="@Search.Clear">
			Clear
		</MudButton>
	</DialogActions>
</MudDialog>