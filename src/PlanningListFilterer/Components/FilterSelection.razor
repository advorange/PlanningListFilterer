@using System.Linq.Expressions;

<MudGrid Class="filter-selection-grid">
	<MudItem xs="12">
		<MudStack Class="filter-selection-stack" Spacing="0">
			<Virtualize Items="@Options">
				<MudCheckBox T="bool" Label="@context" Size="@Size.Small"
							 Checked="@(SelectedItems.Contains(context))"
							 CheckedChanged="@(x => OnCheckedChanged(x, context))" />
			</Virtualize>
		</MudStack>
	</MudItem>
	<MudItem xs="12" Class="d-flex justify-end">
		<MudButton Class="clear-filter-button" OnClick="@Clear">Clear</MudButton>
	</MudItem>
</MudGrid>

@code {
	private Func<AnilistModel, IReadOnlyCollection<string>> _PropertyFunc = null!;

	public ImmutableArray<string> Options => DataGrid
		.FilteredItems
		.SelectMany(x => _PropertyFunc(x))
		.Distinct()
		.OrderByDescending(x => SelectedItems.Contains(x))
		.ThenBy(x => x)
		.ToImmutableArray();
	public ICollection<string> SelectedItems { get; set; } = null!;
	[Parameter]
	public MudDataGrid<AnilistModel> DataGrid { get; set; } = null!;
	[Parameter]
	public Expression<Func<AnilistModel, IReadOnlyCollection<string>>> Property { get; set; } = null!;

	protected override void OnInitialized()
	{
		_PropertyFunc = Property.Compile();

		var property = GetPropertyName();
		var filterDefinition = DataGrid.FilterDefinitions.SingleOrDefault(x => x.Title == property);
		if (filterDefinition is null)
		{
			filterDefinition = new()
			{
				Id = Guid.NewGuid(),
					Title = property,
				Value = new HashSet<string>(),
			};

			DataGrid.AddFilter(filterDefinition);
		}

		SelectedItems = (ICollection<string>)filterDefinition.Value;
		filterDefinition.FilterFunction = m => SelectedItems.All(i => _PropertyFunc(m).Contains(i));
	}

	private string GetPropertyName()
	{
		var expression = (MemberExpression)Property.Body;
		return expression.Member.Name;
	}

	public void OnCheckedChanged(bool value, string item)
	{
		if (value)
		{
			SelectedItems.Add(item);
		}
		else
		{
			SelectedItems.Remove(item);
		}
		DataGrid.ToggleFiltersMenu();
	}

	public void Clear()
		=> SelectedItems.Clear();
}