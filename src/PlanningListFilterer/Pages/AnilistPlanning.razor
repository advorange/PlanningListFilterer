@page "/anilistplanning"
@inject HttpClient Http
@inject ILocalStorageService LocalStorage

<PageTitle>Planning List Filterer</PageTitle>

<MudTable Dense="true" Hover="true" Bordered="true" Striped="true"
		  AllowUnsorted="false" FixedHeader="true" FixedFooter="true"
		  HorizontalScrollbar="true" @ref="Table"
		  Height="85vh" Class="planning-table"
		  Items="@Entries" Context="entry" Filter="@(x => x.IsVisible)">
	<ToolBarContent>
		<MudText Typo="Typo.h6">Planning List Filterer</MudText>
		<MudSpacer />
		<MudSpacer />
		<MudSpacer />
		<MudTextField Class="mb-5" Placeholder="Enter a username to get entries from..."
					  @bind-Value="@Username" />
		<MudButton Color="Color.Primary" OnClick="@LoadEntries">
			Load Entries
		</MudButton>
		<MudButton Color="Color.Primary" OnClick="@RandomizeTable"
				   Disabled="@(Entries.Count == 0)">
			Random
		</MudButton>
		<MudButton Color="Color.Primary" OnClick="@ToggleFilterDialogVisibility"
				   Disabled ="@(Entries.Count == 0)">
			Filter
		</MudButton>
	</ToolBarContent>

	<HeaderContent>
		<ModelTh SortBy="@(m => m.Id)">Id</ModelTh>
		<ModelTh SortBy="@(m => m.Title)">Name</ModelTh>
		<ModelTh SortBy="@(m => m.Start.Time)">Release</ModelTh>
		<ModelTh SortBy="@(m => m.GetHighestEpisode())">Episodes</ModelTh>
		<ModelTh SortBy="@(m => m.GetTotalDuration())">Duration</ModelTh>
		<ModelTh SortBy="@(m => m.AverageScore)">Score</ModelTh>
		<ModelTh SortBy="@(m => m.FriendScore)">Friend Score</ModelTh>
		<ModelTh SortBy="@(m => m.Popularity)">Popularity</ModelTh>
		<ModelTh SortBy="@(m => m.Format.ToString())">Format</ModelTh>
		<ModelTh SortBy="@(m => !m.IsSequel)">Sequel</ModelTh>
		<MudTh>Genres</MudTh>
		<MudTh>Tags</MudTh>
	</HeaderContent>

	<NoRecordsContent>
		@if (IsLoading)
		{
			<MudProgressCircular Color="Color.Default" Indeterminate="true" />
		}
	</NoRecordsContent>

	<RowTemplate>
		<MudTd>
			<MudNavLink Class="transparent-hover-bg" Href="@entry.GetUrl()" Target="_blank">
				<MudImage Src="@entry.CoverImageUrl" ObjectFit="ObjectFit.Fill" />
			</MudNavLink>
		</MudTd>
		<MudTd>@entry.Title</MudTd>
		<MudTd>@entry.DisplayStart()</MudTd>
		<MudTd>@entry.DisplayEpisodeCount()</MudTd>
		<MudTd>@entry.DisplayDuration()</MudTd>
		<MudTd>@entry.DisplayScore()</MudTd>
		<MudTd>@entry.DisplayFriendScore()</MudTd>
		<MudTd>@entry.Popularity</MudTd>
		<MudTd>@entry.DisplayFormat()</MudTd>
		<MudTd>@entry.IsSequel</MudTd>
		<MudTd Class="text-pre">@entry.DisplayGenres()</MudTd>
		<MudTd>
			<MudExpansionPanel Class="bg-transparent no-disabled-text" Text="@entry.DisplayTags(0, 1)"
							   Disabled="@(entry.Tags.Count <= 1)"
							   HideIcon="@(entry.Tags.Count <= 1)">
				<MudText Class="text-pre">@entry.DisplayTags(1, int.MaxValue)</MudText>
			</MudExpansionPanel>
		</MudTd>
	</RowTemplate>

	<PagerContent>
		<MudTablePager />
	</PagerContent>
</MudTable>

<MudDialog Options="@FilterDialogOptions" @bind-IsVisible="@IsFilterDialogVisible">
	<TitleContent>
		<MudText Typo="Typo.h6">Filter</MudText>
	</TitleContent>

	<DialogContent>
		<FilterSelection Source="@Filterer.Genres" Label="Genre" />
		<FilterSelection Source="@Filterer.Tags" Label="Tag" />
		<FilterSelection Source="@Filterer.Formats" Label="Format" />
		<FilterMinMax Source="@Filterer.Score" Label="Score" />
		<FilterMinMax Source="@Filterer.Duration" Label="Duration" />
		<FilterMinMax Source="@Filterer.Year" Label="Year" />
		<FilterMinMax Source="@Filterer.Popularity" Label="Popularity" />
		<FilterBool Source="@Filterer.Sequel">Don't Show Sequels</FilterBool>
	</DialogContent>

	<DialogActions>
		<MudButton Class="float-end" Color="Color.Secondary" Size="Size.Small"
				   OnClick="@Filterer.Clear">
			Clear
		</MudButton>
	</DialogActions>
</MudDialog>