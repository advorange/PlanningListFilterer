@page "/anilistplanning"

@inject HttpClient Http
@inject ILocalStorageService LocalStorage
@inject ListSettingsService ListSettingsService

<PageTitle>Planning List Filterer</PageTitle>

<MudDataGrid Dense="true" Hover="true" Bordered="true" Striped="true" Filterable="true"
			 FixedHeader="true" FixedFooter="true" ShowColumnOptions="false"
			 ColumnResizeMode="ResizeMode.None"
			 FilterMode="DataGridFilterMode.ColumnFilterMenu"
			 Class="planning-table" Height="85vh" Loading="@IsLoading"
			 @ref="Grid" Items="@Entries">
	<ToolBarContent>
		<MudText Typo="Typo.h6">Planning List Filterer</MudText>
		<MudSpacer />
		<MudSpacer />
		<MudSpacer />
		<MudTextField Class="mb-5" Placeholder="Enter a username to get entries from..."
					  @bind-Value="@Username" />
		<MudButton Color="Color.Primary" OnClick="@LoadEntries">
			Load Entries
		</MudButton>
		<MudButton Color="Color.Primary" OnClick="@RandomizeTable"
				   Disabled="@(Entries.Count == 0)">
			Random
		</MudButton>
	</ToolBarContent>

	<Columns>
		<PropertyColumn Property="@(m => m.Id)" SortBy="@(m => m.Id)">
			<CellTemplate>
				<MudNavLink Class="transparent-hover-bg" Target="_blank"
							Href="@context.Item.GetUrl()">
					<MudImage Src="@context.Item.CoverImageUrl" />
				</MudNavLink>
			</CellTemplate>
		</PropertyColumn>
		<PropertyColumn Property="@(m => m.Title)" SortBy="@(m => m.Title)"
						CellClass="text-wrap" />
		<PropertyColumn Property="@(m => m.Start)" SortBy="@(m => m.Start)">
			<CellTemplate>@context.Item.DisplayStart()</CellTemplate>
		</PropertyColumn>
		<PropertyColumn Property="@(m => m.Episodes)" SortBy="@(m => m.Episodes)">
			<CellTemplate>@context.Item.DisplayEpisodeCount()</CellTemplate>
		</PropertyColumn>
		<PropertyColumn Property="@(m => m.Duration)" SortBy="@(m => m.Duration)">
			<CellTemplate>@context.Item.DisplayDuration()</CellTemplate>
		</PropertyColumn>
		<PropertyColumn Property="@(m => m.Score)" SortBy="@(m => m.Score)">
			<CellTemplate>@context.Item.DisplayScore()</CellTemplate>
		</PropertyColumn>
		<PropertyColumn Property="@(m => m.FriendScore)" SortBy="@(m => m.FriendScore)"
						Title="Friend Score" Hidden="@(!ListSettings.EnableFriendScores)">
			<CellTemplate>@context.Item.DisplayFriendScore()</CellTemplate>
		</PropertyColumn>
		<PropertyColumn Property="@(m => m.Popularity)" SortBy="@(m => m.Popularity)" />
		<PropertyColumn Property="@(m => m.Format)" SortBy="@(m => m.Format.ToString())" />
		<PropertyColumn Property="@(m => m.IsSequel)" SortBy="@(m => !m.IsSequel)"
						Title="Sequel" />
		<PropertyColumn Property="@(m => m.Genres)" Sortable="false"
						@ref="@GenreColumn">
			<FilterTemplate>
				<FilterSelection Selector="@(m => m.Genres)" Column="@GenreColumn" />
			</FilterTemplate>

			<CellTemplate>
				<MudText Class="text-pre">@context.Item.DisplayGenres()</MudText>
			</CellTemplate>
		</PropertyColumn>
		<PropertyColumn Property="@(m => m.Tags)" Sortable="false"
						@ref="@TagColumn">
			<FilterTemplate>
				<FilterSelection Selector="@(m => m.Tags.Keys)" Column="@TagColumn" />
			</FilterTemplate>

			<CellTemplate>
				<MudExpansionPanel Class="bg-transparent no-disabled-text"
								   Text="@context.Item.DisplayTags(0, 1)"
								   Disabled="@(context.Item.Tags.Count <= 1)"
								   HideIcon="@(context.Item.Tags.Count <= 1)">
					<MudText Class="text-pre">@context.Item.DisplayTags(1, int.MaxValue)</MudText>
				</MudExpansionPanel>
			</CellTemplate>
		</PropertyColumn>
	</Columns>

	<PagerContent>
		<MudDataGridPager T="AnilistModel" />
	</PagerContent>
</MudDataGrid>

@code {
	public MudDataGrid<AnilistModel> Grid { get; set; } = null!;
	public Column<AnilistModel> GenreColumn { get; set; } = null!;
	public Column<AnilistModel> TagColumn { get; set; } = null!;
}